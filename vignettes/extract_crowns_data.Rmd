---
title: "extract_crowns_data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{extract_crowns_data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(managecrownsdata)
library(dplyr)
library(stringr)
library(sf)
library(DT)
```

```{r, Import data}
crownsFile <- sf::st_read(file.path(system.file(package="managecrownsdata"), '/crowns/crowns_test.gpkg'))
rgb_paths <- list.files(file.path(system.file(package="managecrownsdata"), 'rgb/'), full.names = TRUE)
dates <- paste(
   stringr::str_sub(stringr::str_split(basename(rgb_paths), '_', simplify = TRUE)[,2],1,4),
   stringr::str_sub(stringr::str_split(basename(rgb_paths), '_', simplify = TRUE)[,2],5,6),
   stringr::str_sub(stringr::str_split(basename(rgb_paths), '_', simplify = TRUE)[,2],7,8),
   sep = '_'
)
site = 'Bouamir'
crs <- 'EPSG:32633'
```

```{r, Check the compatibilityof the crowns File}

check_crownsFile(crownsFile = crownsFile)

crownsFile <- crownsFile %>% dplyr::rename(geometry = geom,
                      family = tax_fam,
                      genus = tax_gen,
                      specie = tx_sp_lvl,
                      code_sp = idtax_f)

check_crownsFile(crownsFile = crownsFile)
```

```{r, Visualize the data}

x <- terra::rast(rgb_paths[1])

terra::plotRGB(
   x,
   main = dates[1],
   axes = T,
   mar = 2
)

base::plot(crownsFile$geometry,
           border = "red",
           lwd = 2,
           add = T)
```




```{r}

rgb_extraction <- extract_rgbValues(
      crownsFile = crownsFile,
      path_images = rgb_paths,
      site = site,
      dates = dates,
      crs = crs,
      fun = 'all'
   )


print(rgb_extraction)

```


