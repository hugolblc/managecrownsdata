---
title: "R Notebook"
output: html_notebook
---

First, make sure you have python>3.9 and anaconda / miniconda installed on your device.
If not, you can download them using the following links :


---
After completing the installation steps, you can create your own python environment that will contain everything you need to call this package's functions
```{r}
# Imports
library(reticulate)
library(managecrownsdata)
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
use_condaenv("C:/Users/U051-U219/miniconda3/envs/env_R")
```

```{r}
# Python env creation
env_name <- "managecrownsdata_env"         #use the name you want for your environment

conda_create(env_name, environment = "environment.yaml")
use_condaenv(env_name)
```

The environment you just created contains already all necessary dependences but the Metashape python API, which is required to align photos using TimeSIFT.
To install it, you first need to download a file from the Metashape website : https://www.agisoft.com/downloads/installer/. 
Go to the "Python 3 module" section and click on the link corresponding to your operating system. This should download a file named "Metashape[...].whl". Then, copy the path to the downloaded .whl file below

```{r}
# Add metashape API to env
path_to_whl_file <- "C:/Users/user1/Downloads/Metashape-2.1.3-cp37.cp38.cp39.cp310.cp311-none-win_amd64.whl"   #replace with your path

py_install(path_to_whl_file, envname = env_name, pip=TRUE)
```

Your python environment should be ready for use now. However, Agisoft Metashape requires a paid license in order to access all its features.
It is not necessary to have the Metashape application installed on your device in order for the python API to work, however, Whether or not the application is installed and/or activated, the python API still needs to be activated using a license key (it can be the same used for the application if it is already installed).

To activate the key, follow these steps :

```{r}
# Metashape license activation

your_license_key <- "AAAA-BBBB-CCCC-DDDD"


```
You should be good to go


```{r}
# Test python
source_python("inst/__init__.py")
#source_python(system.file("__init__.py", package = "managecrownsdata"))
```

```{r}
# Try TimeSIFT on test data

Time_SIFT_in_r("test_data/my_drone_data3", 
               out_dir_ortho = "test_data/outputs_TS/ORTHO_24p", 
               #out_dir_DEM = "D:/managecrownsdata/test_data/outputs_TS/DEM_24p",
               data_type = "RGB",
               crs = "EPSG::32633"
               )
```

```{r}
# Try arosics on test data
arosics_in_r(path_in = "D:/managecrownsdata/test_data/outputs_TS/ORTHO_24p/",
             ref_filepath = "D:/managecrownsdata/test_data/Bouamir_LiDAR_mars2022_ref_red.tif", 
             #"D:/managecrownsdata/test_data/outputs_TS/ORTHO4/20220511_ORTHO.tif",
             out_dir_path = "D:/managecrownsdata/test_data/outputs_arosics",
             corr_type = "local",
             grid_res = 200,
             window_size = 500,
             apply_matrix = FALSE,
             save_data = FALSE,
             dynamic_corr = TRUE
             )
```

```{r}
# Using conda
library(reticulate)
conda_create("pipeline_test_R", environment = "environment.yaml")
use_condaenv("pipeline_test_R")
```


```{r}
# Using pip
virtualenv_install("pipeline_test_R", requirements = "requirements.txt")
use_virtualenv("pipeline_test_R")
```
