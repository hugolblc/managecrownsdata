---
title: "R Notebook"
output: html_notebook
---
<h1>Environment setup</h1>

<h2>R package</h2>

If not already installed, you can use devtools to install the "managecrownsdata" package :

```{r}
library(devtools)
install_github("https://github.com/hugolblc/managecrownsdata.git")
```
<h2>Python environment</h2>

First, make sure you have python>3.9 and anaconda / miniconda installed on your device.
If not, you can download them using the following links :

https://www.python.org/downloads/
https://www.anaconda.com/download/

After completing the installation steps, you can create your own python environment that will contain everything you need to call this package's functions

```{r}
# Imports
library(reticulate)
library(managecrownsdata)
```

```{r}
# Python env creation
env_name <- "managecrownsdata_env"         #use the name you want for your environment

conda_create(env_name, environment = "environment.yaml")
use_condaenv(env_name)
```

The environment you just created contains already all necessary dependences but the Metashape python API, which is required to align photos using TimeSIFT.
To install it, you first need to download a file from the Metashape website : https://www.agisoft.com/downloads/installer/. 
Go to the "Python 3 module" section and click on the link corresponding to your operating system. This should download a file named "Metashape[...].whl". Then, copy the path to the downloaded .whl file below

```{r}
# Add metashape API to env
path_to_whl_file <- "C:/Users/user1/Downloads/Metashape-2.1.3-cp37.cp38.cp39.cp310.cp311-none-win_amd64.whl"   #replace with your path

py_install(path_to_whl_file, envname = env_name, pip=TRUE)
```
<h3>Metashape license activation</h3>

Your python environment should be ready for use now. However, Agisoft Metashape requires a paid license in order to access all its features.
It is not necessary to have the Metashape application installed on your device in order for the python API to work, but whether or not the application is installed and/or activated, the API still needs to be activated using a license key (it can be the same used for the application if it is already installed).

To activate the key, follow these steps :

- Open an anaconda command prompt
- Activate the environnement you just created :
$ conda activate managecrownsdata_env
- start python and activate the licence :
$ python
>>> import Metashape
>>> Metashape.license.activate("AAAA-BBBB-CCCC-DDDD")           #replace with your license key

If that works, you can close the command prompt. You should be good to go !

---

<h1>Usage exemple on small dataset</h1>

```{r}
# Imports
library(reticulate)
library(managecrownsdata)


setwd(dirname(rstudioapi::getSourceEditorContext()$path))
use_condaenv(env_name)
```

Please download the exemple data at : ..., and extract it into the package folder

Our test data consists of a few drone images of the same zone taken at two different dates :

<h3>Date 1 :</h3>
<div style="display: flex; justify-content: space-around;">
  <figure style="text-align: center;">
    <img src="test_data/my_drone_data3/RGB_20220427/DJI_0070.JPG" alt="Image 1" width="300" />
    <figcaption>Image1</figcaption>
  </figure>
  <figure style="text-align: center;">
    <img src="test_data/my_drone_data3/RGB_20220427/DJI_0074.JPG" alt="Image 2" width="300" />
    <figcaption>Image 5</figcaption>
  </figure>
  <figure style="text-align: center;">
    <img src="test_data/my_drone_data3/RGB_20220427/DJI_0079.JPG" alt="Image 3" width="300" />
    <figcaption>Image 10</figcaption>
  </figure>
</div>

<h3>Date 2 :</h3>
<div style="display: flex; justify-content: space-around;">
  <figure style="text-align: center;">
    <img src="test_data/my_drone_data3/RGB_20220511/DJI_0278.JPG" alt="Image 1" width="300" />
    <figcaption>Image 1</figcaption>
  </figure>
  <figure style="text-align: center;">
    <img src="test_data/my_drone_data3/RGB_20220511/DJI_0282.JPG" alt="Image 2" width="300" />
    <figcaption>Image 5</figcaption>
  </figure>
  <figure style="text-align: center;">
    <img src="test_data/my_drone_data3/RGB_20220511/DJI_0287.JPG" alt="Image 3" width="300" />
    <figcaption>Image 10</figcaption>
  </figure>
</div>



```{r echo=FALSE, fig.show='hold', out.width='33%'}
images <- c("test_data/my_drone_data3/RGB_20220427/DJI_0070.JPG", "test_data/my_drone_data3/RGB_20220427/DJI_0075.JPG", "test_data/my_drone_data3/RGB_20220427/DJI_0080.JPG")
images_date2 <- c("test_data/my_drone_data3/RGB_20220511/DJI_0278.JPG", "test_data/my_drone_data3/RGB_20220511/DJI_0282.JPG", "test_data/my_drone_data3/RGB_20220511/DJI_0287.JPG")
include_graphics(images)

include_graphics(images_date2)
```

<h2>Time-SIFT</h2>

First, we will use the Time-SIFT method to align all the photos with each other and generate an orthomosaic for each date. This is a rather long process that should take 10~15 minutes to complete on this test data.

```{r}
# Try TimeSIFT on test data

Time_SIFT_in_r("test_data/my_drone_data", 
               out_dir_ortho = "test_data/outputs_TS/ORTHO", 
               #out_dir_DEM = "test_data/outputs_TS/DEM",
               data_type = "RGB",
               crs = "EPSG::32633"
               )


# Conversion to png for display purposes
library(magick)

image_write(image_read("test_data/outputs_TS/ORTHO/20220427_ORTHO.tif"), path = "test_data/outputs_TS/ORTHO/20220427_ORTHO.png", format = "png", quality=100)
image_write(image_read("test_data/outputs_TS/ORTHO/20220511_ORTHO.tif"), path = "test_data/outputs_TS/ORTHO/20220511_ORTHO.png", format = "png", quality=100)
```


<h3>Resulting orthomosaics :</h3>
<div style="display: flex; justify-content: space-around;">
  <figure style="text-align: center;">
    <img src="test_data/outputs_TS/ORTHO_24p/20220427_ORTHO.png" alt="Image 1" width="300" />
    <figcaption>Date 1</figcaption>
  </figure>
  <figure style="text-align: center;">
    <img src="test_data/outputs_TS/ORTHO_24p/20220511_ORTHO.png" alt="Image 1" width="300" />
    <figcaption>Date 2</figcaption>
  </figure>
</div>


<h2>Arosics</h2>
```{r}
# Try arosics on test data
arosics_in_r(path_in = "test_data/outputs_TS/ORTHO/20220427_ORTHO.tif",
             ref_filepath = "test_data/Bouamir_LiDAR_mars2022_ref_red.tif", 
             #"D:/managecrownsdata/test_data/outputs_TS/ORTHO4/20220511_ORTHO.tif",
             out_dir_path = "test_data/outputs_arosics",
             corr_type = "global",
             #grid_res = 200,
             window_size = 500,
             window_pos = list(258131, 352973),
             save_data = TRUE,
             )
```


<h2>Vegetation indexes</h2>

```{r}
extr_dates <- function(names_img) {
   dates <- stringr::str_split(names_img, '_', simplify = TRUE)[,2]
   dates <- stringr::str_remove(dates, '.gpkg')
   return(dates)
}

extr_sites <- function(names_img) {
   sites <- stringr::str_split(names_img, '_', simplify = TRUE)[,1]
   return((sites))
}

extract_rgbValues <-

   function(
      crownsFile,
      path_images,
      sites = NULL,
      dates = NULL,
      fun = 'all',
      infos = FALSE
   ){

# check sites ------------------------------------------

      # Sites should be NULL or a character vector
      if ( !(is.character(sites) | is.null(sites)) ) {
         stop("sites should be a character vector or NULL")
      }

      # Get the sites if NULL from the paths
      if(is.null(sites)){
         sites = extr_sites(basename(path_images))
      }

      # Sites should be a vector of 1 elements or with the same length as path_images
      if ( !(length(sites) == 1 | length(sites) == length(path_images)) ) {
         length_path <- length(path_images)
         stop("length(sites) should be 1 or ", length(path_images), ' not ',length(sites))
      }

      # Return a message if there is more than one site
      if ( length(unique(sites)) > 1 ) {
         length_path <- length(path_images)
         message("You are working with several different sites :", paste(unique(sites), collapse = ' '))
      }

      # I length(site) == 1, create a vector with with the same length as path_images
      if ( length(sites) == 1 ) {
         sites <- rep(sites, length(path_images))
      }


# Check dates -------------------------------------------------------------

      # dates should be NULL or a character vector
      if ( !(is.character(dates) | is.null(dates)) ) {
         stop("dates should be a character vector or NULL")
      }

      # Get the sites if NULL from the paths
      if(is.null(dates)){
         dates = extr_dates(basename(path_images))
      }
      print(dates)
      # dates should be a vector with the same length as path_images
      if ( !(length(dates) == length(path_images)) ) {
         length_path <- length(path_images)
         stop("length(dates) should be ", length(path_images), ' not ',length(sites))
      }

      # dates format should be 'yyymmdd' as character
      if ( FALSE %in% (unique(stringr::str_length(dates) == 8)) ){
         stop("## The format for the dates should be 'yyyymmdd'")
      }

      if ( TRUE %in% (is.na(as.Date(dates, format = "%Y%m%d"))) ) {

         wrong_dates <- dates[is.na(as.Date(dates, format = "%Y%m%d"))]

         stop(paste(
            "\n",
            "## The format for the dates should be 'yyyymmdd'",
            paste(paste(wrong_dates, collapse = ','), 'are not tolerated'),
            sep = "\n"

         ))

      }


# Check crs ---------------------------------------------------------------

      for (i in 1:length(path_images)) {

         check_crs <- (sf::st_crs( terra::rast(path_images[i]) ) == sf::st_crs(crownsFile))

         if(!check_crs){
            stop("The crs from images and crownsFile do not match")
         }

      }


      if( 'date' %in% base::names(crownsFile) ) { crownsFile <- crownsFile %>% dplyr::select(-date) }
      if( infos ) { details <- list() }

      for (i in 1:length(path_images)){

         date_i <- dates[i]
         site_i <- sites[i]

         bbox <-
            terra::rast(path_images[i]) %>%
            sf::st_bbox() %>%
            sf::st_as_sfc() %>%
            sf::st_as_sf()

         within_crowns <- sf::st_join(bbox, crownsFile, join = st_contains) %>% .[['id']]

         if ( infos ) { crowns_rmvd <- crownsFile %>% dplyr::filter (!(id %in% within_crowns)) %>% .[['id']] }

         crowns_i <- crownsFile %>% dplyr::filter (id %in% within_crowns)

         RGB <- terra::rast(path_images[i])
         sumrgb <- RGB[[1]] + RGB[[2]] + RGB[[3]]
         rcc <- RGB[[1]] / sumrgb
         gcc <- RGB[[2]] / sumrgb
         bcc <- RGB[[3]] / sumrgb
         gndvi <- (RGB[[2]] - RGB[[1]]) / (RGB[[2]] + RGB[[1]])
         gli =  ((RGB[[2]] - RGB[[1]]) + (RGB[[2]] - RGB[[3]])) / (RGB[[2]] + sumrgb)

         raster <- c(RGB,sumrgb,rcc,gcc,bcc,gndvi,gli)
         base::names(raster) <- c("red", "green", "blue",'sumrgb','rcc','gcc','bcc','gndvi','gli')
         
         if( fun %in% c('all','mean') ) {

            extr_mean_values <-
               raster %>%
               exactextractr::exact_extract(., crowns_i, progress = TRUE, fun = 'mean') %>%
               `colnames<-`(c("red", "green", "blue",'sumrgb','rcc','gcc','bcc','gndvi','gli')) %>%
               dplyr::mutate(
                  id = crowns_i$id,
                  type = 'RGB',
                  metric = 'mean',
                  date = date_i,
                  site = site_i

               ) %>%
               tidyr::gather(-c(id, type, metric, date, site), key = band, value = value)
            
         }
         

         if( fun %in% c('all','var') ) {

            extr_var_values <-
               raster %>%
               exactextractr::exact_extract(., crowns_i, progress = TRUE, fun = 'variance') %>%
               `colnames<-`(c("red", "green", "blue",'sumrgb','rcc','gcc','bcc','gndvi','gli')) %>%
               dplyr::mutate(
                  id = crowns_i$id,
                  type = 'RGB',
                  metric = 'var',
                  date = date_i,
                  site = site_i
               ) %>%
               tidyr::gather(-c(id, type, metric, date, site), key = band, value = value)
         }

         if( fun == 'all' ) {

            extr_date_i <-
               rbind(extr_mean_values, extr_var_values) %>%
               dplyr::inner_join(., crowns_i, by = 'id') %>%
               dplyr::as_tibble()

         }

         if( fun == 'mean' ) {

            extr_date_i <-
               extr_mean_values %>%
               dplyr::inner_join(., crowns_i, by = 'id') %>%
               dplyr::as_tibble()

         }

         if( fun == 'var' ) {

            extr_date_i <-
               extr_var_values %>%
               dplyr::inner_join(., crowns_i, by = 'id') %>%
               dplyr::as_tibble()

         }

         if(i == 1 & infos) { details[[paste0(date_i)]] <- crowns_rmvd }
         if(i != 1 & infos) { details[[paste0(date_i)]] <- crowns_rmvd }

         if(i == 1) { extr_alldates <- extr_date_i } else { extr_alldates <- rbind(extr_alldates, extr_date_i) }

         gc()

      }

      if ( infos ) {

         extr_alldates <- extr_alldates %>% dplyr::mutate (date = as.Date(date, '%Y_%m_%d'),
                                                           site = as.factor(site),
                                                           family = as.factor(family),
                                                           genus = as.factor(genus),
                                                           species = as.factor(species),
                                                           type = as.factor(type),
                                                           metric = as.factor(metric),
                                                           band = as.factor(band),
                                                           plot_name = as.factor(plot_name),
                                                           id = as.integer(id)) %>%
            dplyr::select(site, id, date, family, genus, species, type, metric, band, value, plot_name, code_sp)

         return(
            list(
               extr_alldates = extr_alldates,
               removed_crowns = details
            )
         )
      } else {

         extr_alldates <- extr_alldates %>% dplyr::mutate (date = as.Date(date, '%Y%m%d'),
                                                           site = as.factor(site),
                                                           family = as.factor(tax_fam),
                                                           genus = as.factor(tax_gen),
                                                           species = as.factor(tx_sp_lvl),
                                                           type = as.factor(type),
                                                           metric = as.factor(metric),
                                                           band = as.factor(band),
                                                           plot_name = as.factor(plot_name),
                                                           code_sp = as.factor(tx_sp_lvl),
                                                           id = as.integer(id)) %>%
            dplyr::select(site, id, date, family, genus, species, type, metric, band, value, plot_name, code_sp)
         return(extr_alldates)

      }

   }
```

```{r}
library(sf)
res <- extract_rgbValues(crownsFile = sf::read_sf("test_data/Bouamir_crowns_2024_11_04_filtered.gpkg"), 
                         path_images = list.files("test_data/outputs_arosics/", full.names = TRUE),
                         )
```
